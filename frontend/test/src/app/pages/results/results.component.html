<div class="results-page">
  <div class="page-header">
    <h1>Ergebnisse</h1>
  </div>

  @if (isLoading()) {
    <div class="loading">Lade Ergebnisse...</div>
  } @else if (templates().length === 0) {
    <mat-card>
      <mat-card-content>
        <p>Keine Fragebogen-Vorlagen verfügbar.</p>
      </mat-card-content>
    </mat-card>
  } @else {
    <!-- Template-Auswahl -->
    <mat-card class="template-selector">
      <mat-card-content>
        <label for="template-select">Fragebogen-Vorlage:</label>
        <select
          id="template-select"
          [value]="selectedTemplateId()"
          (change)="onTemplateChange($any($event.target).value)"
          class="template-select"
        >
          @for (template of templates(); track template.id) {
            <option [value]="template.id">{{ template.name }} (v{{ template.version }})</option>
          }
        </select>
      </mat-card-content>
    </mat-card>

    <!-- Ergebnisse -->
    @if (results().length > 0) {
      <mat-card>
        <mat-card-header>
          <mat-card-title>Auswertung nach Kategorien</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="results()" class="results-table">
            <ng-container matColumnDef="category">
              <th mat-header-cell *matHeaderCellDef>Kategorie</th>
              <td mat-cell *matCellDef="let result">{{ result.category }}</td>
            </ng-container>

            <ng-container matColumnDef="subcategory">
              <th mat-header-cell *matHeaderCellDef>Unterkategorie</th>
              <td mat-cell *matCellDef="let result">{{ result.subcategory }}</td>
            </ng-container>

            <ng-container matColumnDef="average">
              <th mat-header-cell *matHeaderCellDef>Durchschnitt</th>
              <td mat-cell *matCellDef="let result">
                <span class="average-badge" [class]="getAverageColor(result.average)">
                  {{ result.average.toFixed(2) }}
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="answered">
              <th mat-header-cell *matHeaderCellDef>Beantwortet</th>
              <td mat-cell *matCellDef="let result">
                {{ result.answeredCount }} / {{ result.totalCount }}
                ({{ getPercentage(result.answeredCount, result.totalCount) }}%)
              </td>
            </ng-container>

            <ng-container matColumnDef="reverse">
              <th mat-header-cell *matHeaderCellDef>Reverse-Items</th>
              <td mat-cell *matCellDef="let result">
                @if (result.reverseItems.length > 0) {
                  <div class="reverse-items">
                    @for (itemId of result.reverseItems; track itemId) {
                      <span class="reverse-chip">{{ itemId }}</span>
                    }
                  </div>
                } @else {
                  <span class="no-reverse">-</span>
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    } @else {
      <mat-card>
        <mat-card-content>
          <p>Noch keine Ergebnisse verfügbar.</p>
        </mat-card-content>
      </mat-card>
    }
  }
</div>
