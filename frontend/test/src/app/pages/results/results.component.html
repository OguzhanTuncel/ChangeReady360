<div class="results-page">
  <!-- Management Summary Section -->
  <div class="management-summary-section">
    <div class="summary-header">
      <h1 class="summary-title">Management Summary</h1>
      <p class="summary-date">Stand: {{ getCurrentDate() }}</p>
    </div>

    <!-- KPI Cards -->
    @if (managementSummary()) {
      <div class="kpi-cards-grid">
        <mat-card class="kpi-card">
          <div class="kpi-content">
            <div class="kpi-header">
              <span class="kpi-title">Gesamt-Readiness</span>
            </div>
            <div class="kpi-value">{{ managementSummary()!.overallReadiness }}%</div>
          </div>
        </mat-card>
        @if (managementSummary()!.readinessTrend !== 0) {
          <mat-card class="kpi-card">
            <div class="kpi-content">
              <div class="kpi-header">
                <span class="kpi-title">Trend (30 Tage)</span>
              </div>
              <div class="kpi-value" [class]="managementSummary()!.readinessTrend > 0 ? 'trend-positive' : 'trend-negative'">
                {{ managementSummary()!.readinessTrend > 0 ? '+' : '' }}{{ managementSummary()!.readinessTrend }}%
              </div>
            </div>
          </mat-card>
        }
        <mat-card class="kpi-card">
          <div class="kpi-content">
            <div class="kpi-header">
              <span class="kpi-title">Stakeholder</span>
            </div>
            <div class="kpi-value">{{ managementSummary()!.stakeholderCount }}</div>
          </div>
        </mat-card>
        @if (managementSummary()!.activeMeasuresCount > 0) {
          <mat-card class="kpi-card">
            <div class="kpi-content">
              <div class="kpi-header">
                <span class="kpi-title">Aktive Maßnahmen</span>
              </div>
              <div class="kpi-value">{{ managementSummary()!.activeMeasuresCount }}</div>
            </div>
          </mat-card>
        }
      </div>
    } @else {
      <div class="empty-summary">
        <mat-icon>bar_chart</mat-icon>
        <p>Keine Management Summary-Daten verfügbar</p>
      </div>
    }

    <!-- Department Cards -->
    @if (departmentReadiness().length > 0) {
      <div class="department-cards-grid">
        @for (dept of departmentReadiness(); track dept.id) {
          <mat-card class="department-card">
            <div class="department-content">
              <h3 class="department-name">{{ dept.name }}</h3>
              <div class="department-readiness" [style.color]="getDepartmentColor(dept.readiness)">
                {{ dept.readiness }}%
              </div>
            </div>
          </mat-card>
        }
      </div>
    }
  </div>

  <!-- Trend Chart Section -->
  <div class="trend-chart-section">
    <mat-card class="trend-card">
      <mat-card-header>
        <mat-card-title>Readiness-Verlauf & Prognose</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (trendData() && trendData()!.dataPoints.length > 0) {
          <app-line-chart 
            [dataPoints]="trendData()!.dataPoints"
            [width]="800"
            [height]="400"
            [showTarget]="true">
          </app-line-chart>
        } @else {
          <div class="empty-trend">
            <mat-icon>show_chart</mat-icon>
            <p>Keine Trend-Daten verfügbar</p>
          </div>
        }
      </mat-card-content>
    </mat-card>
  </div>

  <div class="page-header">
    <h1>Ergebnisse</h1>
    <p class="description-text">
      Hier sehen Sie die Auswertung Ihrer abgeschlossenen Umfrage. Der Score zeigt die aktuelle Change-Readiness Ihres Unternehmens auf einen Blick.
    </p>
  </div>

  @if (isLoading()) {
    <div class="loading">Lade Ergebnisse...</div>
  } @else if (templates().length === 0) {
    <mat-card>
      <mat-card-content>
        <p>Keine Fragebogen-Vorlagen verfügbar.</p>
      </mat-card-content>
    </mat-card>
  } @else {
    <!-- Template-Auswahl -->
    <mat-card class="template-selector">
      <mat-card-content>
        <label for="template-select">Fragebogen-Vorlage:</label>
        <select
          id="template-select"
          [value]="selectedTemplateId()"
          (change)="onTemplateChange($any($event.target).value)"
          class="template-select"
        >
          @for (template of templates(); track template.id) {
            <option [value]="template.id">{{ template.name }} (v{{ template.version }})</option>
          }
        </select>
      </mat-card-content>
    </mat-card>

    <!-- Gesamt-Score Donut-Diagramm (immer sichtbar) -->
    <mat-card class="score-card">
      <mat-card-content>
        <div class="score-content">
          <div class="donut-container">
            <svg width="220" height="220" viewBox="0 0 200 200" class="donut-chart">
              <!-- Hintergrund-Kreis (Creme) -->
              <circle
                cx="100"
                cy="100"
                r="75"
                fill="none"
                stroke="#F5F3F0"
                stroke-width="28"
              />
              <!-- Score-Kreis (Innovera-Blau) -->
              <circle
                cx="100"
                cy="100"
                r="75"
                fill="none"
                stroke="#31749B"
                stroke-width="28"
                [attr.stroke-dasharray]="getDonutCircumference()"
                [attr.stroke-dashoffset]="getDonutOffset()"
                stroke-linecap="round"
                transform="rotate(-90 100 100)"
                class="score-circle"
              />
              <!-- Text in der Mitte -->
              <text x="100" y="95" text-anchor="middle" class="score-value">{{ getOverallScore() }}%</text>
              <text x="100" y="110" text-anchor="middle" class="score-label">Gesamt-Score</text>
            </svg>
          </div>
          <div class="score-evaluation">
            <h3>Bewertung</h3>
            <ul class="evaluation-list">
              @if (results().length > 0) {
                <li>
                  <strong>Aktueller Stand:</strong> {{ getEvaluationText().current }}
                </li>
                <li>
                  <strong>Kritische Bereiche:</strong> {{ getEvaluationText().critical }}
                </li>
                <li>
                  <strong>Positive Aspekte:</strong> {{ getEvaluationText().positive }}
                </li>
              } @else {
                <li>
                  <strong>Status:</strong> Noch keine Antworten vorhanden. Bitte füllen Sie zunächst einen Fragebogen aus.
                </li>
                <li>
                  <strong>Nächster Schritt:</strong> Starten Sie einen Fragebogen, um Ihre Change-Readiness zu bewerten.
                </li>
                <li>
                  <strong>Hinweis:</strong> Der Score wird automatisch aktualisiert, sobald Daten verfügbar sind.
                </li>
              }
            </ul>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Ergebnisse mit Tabs -->
    @if (results().length > 0 || departmentResults().length > 0) {
      <mat-card>
        <mat-card-content>
          <mat-tab-group [selectedIndex]="selectedTab()" (selectedIndexChange)="selectedTab.set($event)">
            <!-- Tab: Gesamtauswertung -->
            <mat-tab label="Gesamtauswertung">
              @if (results().length > 0) {
                <div class="tab-content">
                  <mat-card>
                    <mat-card-header>
                      <mat-card-title>Auswertung nach Kategorien</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      <table mat-table [dataSource]="results()" class="results-table">
                        <ng-container matColumnDef="category">
                          <th mat-header-cell *matHeaderCellDef>Kategorie</th>
                          <td mat-cell *matCellDef="let result">{{ result.category }}</td>
                        </ng-container>

                        <ng-container matColumnDef="subcategory">
                          <th mat-header-cell *matHeaderCellDef>Unterkategorie</th>
                          <td mat-cell *matCellDef="let result">{{ result.subcategory }}</td>
                        </ng-container>

                        <ng-container matColumnDef="average">
                          <th mat-header-cell *matHeaderCellDef>Durchschnitt</th>
                          <td mat-cell *matCellDef="let result">
                            <span class="average-badge" [class]="getAverageColor(result.average)">
                              {{ result.average.toFixed(2) }}
                            </span>
                          </td>
                        </ng-container>

                        <ng-container matColumnDef="answered">
                          <th mat-header-cell *matHeaderCellDef>Beantwortet</th>
                          <td mat-cell *matCellDef="let result">
                            {{ result.answeredCount }} / {{ result.totalCount }}
                            ({{ getPercentage(result.answeredCount, result.totalCount) }}%)
                          </td>
                        </ng-container>

                        <ng-container matColumnDef="reverse">
                          <th mat-header-cell *matHeaderCellDef>Reverse-Items</th>
                          <td mat-cell *matCellDef="let result">
                            @if (result.reverseItems.length > 0) {
                              <div class="reverse-items">
                                @for (itemId of result.reverseItems; track itemId) {
                                  <span class="reverse-chip">{{ itemId }}</span>
                                }
                              </div>
                            } @else {
                              <span class="no-reverse">-</span>
                            }
                          </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                      </table>
                    </mat-card-content>
                  </mat-card>
                </div>
              } @else {
                <div class="tab-content">
                  <p>Noch keine Gesamtergebnisse verfügbar.</p>
                </div>
              }
            </mat-tab>

            <!-- Tab: Auswertung nach Abteilungen -->
            <mat-tab label="Nach Abteilungen">
              @if (departmentResults().length > 0) {
                <div class="tab-content">
                  <div class="department-results-grid">
                    @for (deptResult of departmentResults(); track deptResult.department) {
                      <mat-card class="department-card">
                        <mat-card-header>
                          <mat-card-title>
                            {{ departmentDisplayNames[deptResult.department] }}
                          </mat-card-title>
                          <mat-card-subtitle>
                            {{ deptResult.participantCount }} {{ deptResult.participantCount === 1 ? 'Person' : 'Personen' }}
                          </mat-card-subtitle>
                        </mat-card-header>
                        <mat-card-content>
                          <!-- Department Score Donut -->
                          <div class="department-score">
                            @let deptScore = getDepartmentScore(deptResult.results);
                            <svg width="150" height="150" viewBox="0 0 200 200" class="donut-chart-small">
                              <circle
                                cx="100"
                                cy="100"
                                r="60"
                                fill="none"
                                stroke="#F5F3F0"
                                stroke-width="20"
                              />
                              <circle
                                cx="100"
                                cy="100"
                                r="60"
                                fill="none"
                                stroke="#31749B"
                                stroke-width="20"
                                [attr.stroke-dasharray]="getDonutCircumference()"
                                [attr.stroke-dashoffset]="getDepartmentDonutOffset(deptScore)"
                                stroke-linecap="round"
                                transform="rotate(-90 100 100)"
                              />
                              <text x="100" y="95" text-anchor="middle" class="score-value-small">{{ deptScore }}%</text>
                              <text x="100" y="110" text-anchor="middle" class="score-label-small">Score</text>
                            </svg>
                          </div>

                          <!-- Department Results Table -->
                          @if (deptResult.results.length > 0) {
                            <table mat-table [dataSource]="deptResult.results" class="department-results-table">
                              <ng-container matColumnDef="category">
                                <th mat-header-cell *matHeaderCellDef>Kategorie</th>
                                <td mat-cell *matCellDef="let result">{{ result.category }}</td>
                              </ng-container>

                              <ng-container matColumnDef="subcategory">
                                <th mat-header-cell *matHeaderCellDef>Unterkategorie</th>
                                <td mat-cell *matCellDef="let result">{{ result.subcategory }}</td>
                              </ng-container>

                              <ng-container matColumnDef="average">
                                <th mat-header-cell *matHeaderCellDef>Durchschnitt</th>
                                <td mat-cell *matCellDef="let result">
                                  <span class="average-badge" [class]="getAverageColor(result.average)">
                                    {{ result.average.toFixed(2) }}
                                  </span>
                                </td>
                              </ng-container>

                              <tr mat-header-row *matHeaderRowDef="['category', 'subcategory', 'average']"></tr>
                              <tr mat-row *matRowDef="let row; columns: ['category', 'subcategory', 'average']"></tr>
                            </table>
                          }
                        </mat-card-content>
                      </mat-card>
                    }
                  </div>
                </div>
              } @else {
                <div class="tab-content">
                  <p>Noch keine Abteilungsergebnisse verfügbar.</p>
                </div>
              }
            </mat-tab>
          </mat-tab-group>
        </mat-card-content>
      </mat-card>
    } @else {
      <mat-card>
        <mat-card-content>
          <p>Noch keine Ergebnisse verfügbar.</p>
        </mat-card-content>
      </mat-card>
    }
  }
</div>

