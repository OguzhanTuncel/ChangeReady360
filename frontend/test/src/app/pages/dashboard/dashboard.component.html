<div class="dashboard-page">
  <h1 class="page-header">Change-Readiness Dashboard</h1>
  <p class="page-subtitle">{{ getCurrentDate() }}</p>

  @if (errorMessage()) {
    <div class="error-message" style="background-color: #ffebee; color: #c62828; padding: 16px; border-radius: 4px; margin-bottom: 16px;">
      <strong>Fehler:</strong> {{ errorMessage() }}
    </div>
  }

  @if (isLoading()) {
    <div class="loading">Lade Dashboard...</div>
  } @else {
    <!-- KPI Cards Top Row -->
    @if (kpiCards.length > 0) {
      <div class="kpi-cards-grid">
        @for (card of kpiCards; track card.title) {
        <mat-card class="kpi-card" [class.clickable]="card.route" (click)="card.route && navigateToCard(card.route)">
          <div class="kpi-content">
            <div class="kpi-header">
              <mat-icon class="kpi-icon">{{ card.icon }}</mat-icon>
              <span class="kpi-title">{{ card.title }}</span>
            </div>
            <div class="kpi-value">{{ card.value }}</div>
            @if (card.change) {
              <div class="kpi-change" [class.positive]="card.change.startsWith('+')" [class.negative]="card.change.startsWith('-')">
                {{ card.change }}
              </div>
            } @else if (card.title === 'Stakeholder' && kpis()?.stakeholderGroupsCount) {
              <div class="kpi-subtitle">in {{ kpis()!.stakeholderGroupsCount }} Gruppen</div>
            } @else if (card.title === 'Kritiker' && kpis()?.criticsCount && kpis()!.criticsCount > 0) {
              <div class="kpi-subtitle">benötigen Aufmerksamkeit</div>
            } @else if (card.title === 'Offene Maßnahmen' && kpis()?.overdueMeasuresCount && kpis()!.overdueMeasuresCount > 0) {
              <div class="kpi-subtitle">davon {{ kpis()!.overdueMeasuresCount }} überfällig</div>
            }
          </div>
        </mat-card>
        }
      </div>
    } @else {
      <div class="empty-kpis">
        <p>Keine Dashboard-Daten verfügbar</p>
      </div>
    }

    <!-- Main Content Grid -->
    <div class="main-content-grid">
      <!-- Gesamt-Readiness Card -->
      <mat-card class="readiness-card">
        <mat-card-header>
          <mat-card-title>Gesamt-Readiness</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (readinessData()) {
            <div class="readiness-content">
              <div class="donut-wrapper">
                <app-donut-chart 
                  [value]="readinessData()!.overallReadiness" 
                  [size]="220" 
                  [strokeWidth]="28">
                </app-donut-chart>
                <div class="donut-center-label">
                  {{ (kpis()?.readinessScore ?? readinessData()!.overallReadiness) }}%
                </div>
              </div>
              <div class="readiness-stats">
                <div class="stat-item promoter">
                  <span class="stat-count">{{ readinessData()!.promoters }}</span>
                  <span class="stat-label">Promoter</span>
                </div>
                <div class="stat-item neutral">
                  <span class="stat-count">{{ readinessData()!.neutrals }}</span>
                  <span class="stat-label">Neutral</span>
                </div>
                <div class="stat-item critic">
                  <span class="stat-count">{{ readinessData()!.critics }}</span>
                  <span class="stat-label">Kritiker</span>
                </div>
              </div>
            </div>
          } @else {
            <div class="empty-readiness">
              <p>Noch keine Readiness-Daten verfügbar</p>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Stakeholder-Gruppen Card -->
      <mat-card class="stakeholder-groups-card">
        <mat-card-header>
          <mat-card-title>Stakeholder-Gruppen</mat-card-title>
          <a routerLink="/app/stakeholder" class="view-all-link">Alle anzeigen →</a>
        </mat-card-header>
        <mat-card-content>
          @if (stakeholderGroups().length > 0) {
            <div class="groups-list">
              @for (group of stakeholderGroups().slice(0, 5); track group.id) {
                <div class="group-item">
                  <div class="group-header">
                    <div class="group-info">
                      <mat-icon class="group-icon">{{ group.icon }}</mat-icon>
                      <div class="group-details">
                        <span class="group-name">{{ group.name }}</span>
                        <span class="group-participants">{{ group.participantCount }} Personen</span>
                      </div>
                    </div>
                    <span class="status-badge" [class]="getStatusBadgeClass(group.status)">
                      {{ getStatusBadgeText(group.status) }}
                    </span>
                  </div>
                  <div class="group-progress">
                    <div class="progress-bar-container">
                      <div 
                        class="progress-bar" 
                        [style.width.%]="group.readiness"
                        [class]="getStatusBadgeClass(group.status)">
                      </div>
                    </div>
                    <div class="group-metrics">
                      <span class="readiness-value">{{ group.readiness }}%</span>
                      <span class="trend-indicator" [class]="getTrendClass(group.trend)">
                        <mat-icon class="trend-icon">{{ getTrendIcon(group.trend) }}</mat-icon>
                        {{ formatTrend(group.trend) }}
                      </span>
                    </div>
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-groups">
              <p>Noch keine Stakeholder-Gruppen verfügbar</p>
            </div>
          }
        </mat-card-content>
      </mat-card>
    </div>
  }
</div>

